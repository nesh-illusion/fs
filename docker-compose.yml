services:
  lucius_orchestrator:
    build:
      context: .
      dockerfile: services/lucius_orchestrator/Dockerfile
    ports:
      - "8000:8000"
    environment:
      LUCIUS_STORAGE_BACKEND: "memory"

  lucius_dispatcher_0:
    build:
      context: .
      dockerfile: services/lucius_dispatcher/Dockerfile
    environment:
      LUCIUS_STORAGE_BACKEND: "memory"
    command: ["lucius-reconciliation", "loop", "--shard-index", "0", "--shard-count", "2", "--interval", "5"]

  lucius_dispatcher_1:
    build:
      context: .
      dockerfile: services/lucius_dispatcher/Dockerfile
    environment:
      LUCIUS_STORAGE_BACKEND: "memory"
    command: ["lucius-reconciliation", "loop", "--shard-index", "1", "--shard-count", "2", "--interval", "5"]

  embedding:
    build:
      context: .
      dockerfile: services/embedding/Dockerfile

  ocr:
    build:
      context: .
      dockerfile: services/ocr/Dockerfile

  sis:
    build:
      context: .
      dockerfile: services/sis/Dockerfile

  test_runner:
    build:
      context: .
      dockerfile: services/test_runner/Dockerfile
    environment:
      PYTHONDONTWRITEBYTECODE: "1"
      TMPDIR: "/tmp"
    depends_on:
      - lucius_orchestrator
      - lucius_dispatcher_0
      - lucius_dispatcher_1
      - ocr
      - embedding
      - sis
