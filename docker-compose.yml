services:
  lucius-orchestrator:
    build:
      context: .
      dockerfile: services/lucius-orchestrator/Dockerfile
    ports:
      - "8000:8000"
    environment:
      LUCIUS_STORAGE_BACKEND: "memory"
      LUCIUS_TEMPORAL_ADDRESS: "temporal:7233"
      LUCIUS_TEMPORAL_NAMESPACE: "default"
      LUCIUS_TEMPORAL_TASK_QUEUE: "lucius"

  vector-ingestion:
    build:
      context: .
      dockerfile: services/vector-ingestion/Dockerfile
    environment:
      SERVICEBUS_CONNECTION: "Endpoint=sb://...;SharedAccessKeyName=...;SharedAccessKey=..."
      SERVICEBUS_TOPIC: "global-bus-p0"
      SERVICEBUS_SUBSCRIPTION: "vector-ingestion"

  distributed-ocr:
    build:
      context: .
      dockerfile: services/distributed-ocr/Dockerfile
    environment:
      SERVICEBUS_CONNECTION: "Endpoint=sb://...;SharedAccessKeyName=...;SharedAccessKey=..."
      SERVICEBUS_TOPIC: "global-bus-p0"
      SERVICEBUS_SUBSCRIPTION: "distributed-ocr"

  semantic-intelligence:
    build:
      context: .
      dockerfile: services/semantic-intelligence/Dockerfile
    environment:
      SERVICEBUS_CONNECTION: "Endpoint=sb://...;SharedAccessKeyName=...;SharedAccessKey=..."
      SERVICEBUS_TOPIC: "global-bus-p0"
      SERVICEBUS_SUBSCRIPTION: "semantic-intelligence"

  lucius-temporal-worker:
    build:
      context: .
      dockerfile: services/lucius-orchestrator/Dockerfile
    command: ["python", "-m", "temporal_worker.main"]
    environment:
      LUCIUS_SERVICEBUS_CONNECTION: "Endpoint=sb://...;SharedAccessKeyName=...;SharedAccessKey=..."
      LUCIUS_TEMPORAL_ADDRESS: "temporal:7233"
      LUCIUS_TEMPORAL_NAMESPACE: "default"
      LUCIUS_TEMPORAL_TASK_QUEUE: "lucius"
      LUCIUS_ORCHESTRATOR_URL: "http://lucius-orchestrator:8000"
      LUCIUS_STEP_RESULT_TIMEOUT_SECONDS: "900"
      LUCIUS_MAX_ATTEMPTS: "3"
      LUCIUS_LEASE_MINUTES: "15"
    depends_on:
      - lucius-orchestrator
      - temporal

  temporal-postgres:
    image: postgres:13
    environment:
      POSTGRES_USER: temporal
      POSTGRES_PASSWORD: temporal
    ports:
      - "5432:5432"

  temporal:
    image: temporalio/auto-setup:latest
    environment:
      DB: postgresql
      DB_PORT: 5432
      POSTGRES_SEEDS: temporal-postgres
      POSTGRES_USER: temporal
      POSTGRES_PWD: temporal
    ports:
      - "7233:7233"
    depends_on:
      - temporal-postgres

  test_runner:
    build:
      context: .
      dockerfile: services/test_runner/Dockerfile
    environment:
      PYTHONDONTWRITEBYTECODE: "1"
      TMPDIR: "/tmp"
    depends_on:
      - lucius-orchestrator
      - distributed-ocr
      - vector-ingestion
      - semantic-intelligence
